<!DOCTYPE html>
<html>
  <body>
    <canvas id="simulation" width="800" height="600"></canvas>
    <script type="text/javascript">
      var square = [];
      var polar = [];
      var target = [];
      var sideLength = 250;
      var range = 500;
      /*
      for (var i = 0; i < range; i++) {
        target.push({
          'x': -sideLength / 2 + (i * sideLength / range),
          'y': -sideLength / 2
        });
      }
      for (var i = 0; i < range; i++) {
        target.push({
          'x': sideLength / 2,
          'y': -sideLength / 2 + (i * sideLength / range)
        });
      }
      for (var i = 0; i < range; i++) {
        target.push({
          'x': sideLength / 2 - (i * sideLength / range),
          'y': sideLength / 2
        });
      }
      for (var i = 0; i < range; i++) {
        target.push({
          'x': -sideLength / 2,
          'y': sideLength / 2 - (i * sideLength / range)
        });
      }
      */
      for (var i = 0; i < range; i++) {
        var x1 = 0;
        var y1 = -sideLength;
        var x2 = .866 * sideLength;
        var y2 = sideLength * .5;
        var x3 = -.866 * sideLength;
        var y3 = sideLength * .5;
        if (i < range / 3) {
          var progress = i * 3 / range;
          target.push({
            'x': x2 * progress + (1 - progress) * x1,
            'y': y2 * progress + (1 - progress) * y1,
          });
        } else if (i < range * 2 / 3) {
          var progress = (i - range / 3) * 3 / range;
          target.push({
            'x': x3 * progress + (1 - progress) * x2,
            'y': y3 * progress + (1 - progress) * y2,
          });
        } else {
          var progress = (i - 2 * range / 3) * 3 / range;
          target.push({
            'x': x1 * progress + (1 - progress) * x3,
            'y': y1 * progress + (1 - progress) * y3,
          });
        }
      }
      for (var i = 0; i < target.length; i++) {
        var coordinate = target[i];
        var x = coordinate.x;
        var y = coordinate.y;
        var r = Math.sqrt(x * x + y * y);
        var a = Math.atan2(y, x);
        polar.push({'r': r, 'a': a});
        var theta = 2 * Math.asin(r / (2 * 125));
        var phi = Math.acos(r / (2 * 125)) + a;
        square.push({'stepper_angle': phi, 'servo_angle': Math.PI + phi + theta});
      }
      var index = 0;
      function drawCanvas() {
        var canvas = document.getElementById('simulation');
        var context = canvas.getContext('2d');
        context.clearRect(0, 0, 800, 600);
        context.beginPath();
        context.arc(400, 300, 250, 0, 2 * Math.PI);
        context.stroke();

        var armAngles = square[index];
        var stepper_end = {
          'x': 400 + 125 * Math.cos(armAngles.stepper_angle),
          'y': 300 + 125 * Math.sin(armAngles.stepper_angle)
        };
        var servo_end = {
          'x': stepper_end.x + 125 * Math.cos(armAngles.servo_angle),
          'y': stepper_end.y + 125 * Math.sin(armAngles.servo_angle)
        };
        context.beginPath();
        context.moveTo(400, 300);
        context.lineTo(stepper_end.x, stepper_end.y);
        context.stroke();
        context.beginPath();
        context.moveTo(stepper_end.x, stepper_end.y);
        context.lineTo(servo_end.x, servo_end.y);
        context.stroke();
        context.beginPath();
        context.arc(400 + target[index].x, 300 + target[index].y, 10, 0, 2 * Math.PI);
        context.stroke();

        context.beginPath();
        context.arc(
            400 + polar[index].r * Math.cos(polar[index].a),
            300 + polar[index].r * Math.sin(polar[index].a), 10, 0, 2 * Math.PI);
        context.stroke();
        if (++index >= square.length) {
          index = 0;
        }
        setTimeout(drawCanvas, 10000 / range);
      }
      setTimeout(drawCanvas, 10000 / range);
    </script>
  </body>
</html>
